import numpy as np
from scipy import interpolate
from scipy.optimize import Bounds


def _preprocess_polyline(eps, _lm, ilm):

    __lm = np.vstack(
        (
            _lm[_lm[:, 0] < eps],  # trim the polyline
            [eps, ilm(eps)],  # add the intersection point
            [eps, 0],  # project the intersection point to the x-axis
            [_lm[0, 0], _lm[0, 1]],  # add the origin, e.g. close the polyline
        )
    )
    return __lm


def prep(eps, _lm, ilm, _lm_pad):

    sig = ilm(eps)

    i = np.searchsorted(_lm[:, EPS], eps, side="left")  #

    _lm_pad[all_timesteps, i, EPS] = eps
    _lm_pad[all_timesteps, i, SIG] = sig

    _lm_pad[all_timesteps, i + 1, EPS] = eps
    _lm_pad[all_timesteps, i + 1, SIG] = 0

    mask = np.arange(_lm.shape[0] + 2) > (i[:, None] + 1)
    _lm_pad[mask] = 0

    return _lm_pad


def m0(_lm_pad):
    x = _lm_pad[:, :, EPS]
    z = _lm_pad[:, :, SIG]
    return 0.5 * np.abs(np.sum(x[:, :-1] * z[:, 1:] - z[:, :-1] * x[:, 1:], axis=1))


def m1(_lm_pad):
    x = _lm_pad[:, :, EPS]
    z = _lm_pad[:, :, SIG]
    return (1 / 6) * np.abs(
        np.sum(
            (x[:, :-1] + x[:, 1:]) * (x[:, :-1] * z[:, 1:] - x[:, 1:] * z[:, :-1]),
            axis=1,
        )
    )


h = 300  # [mm]
h_u = 0.5 * h  # [mm] upper half
h_d = 0.5 * h  # [mm] lower half

b = 1  # [mm]

E = 60_000  # [MPa]
I = (b * h**3) / 12  # [mm^4]
W = (b * h**2) / 6  # [mm^3]

# TODO: should be given as mm/m, not as mm/mm (i.e. 1/1000)
_ft = np.array([[0 / 1000, 0], [2 / 1000, 50], [4 / 1000, 50], [8 / 1000, 75]])
_cc = np.array([[0 / 1000, 0], [3 / 1000, 180], [10 / 1000, 180]])

num_timesteps = 200
all_timesteps = np.arange(num_timesteps)
num_vertices_ft = _ft.shape[0]
num_vertices_cc = _cc.shape[0]
num_dim = 2

EPS = 0
SIG = 1

# reasoning: to keep the possibility of vectorization, the data is padded with
# 0s, as the first and last value of the polyline is always 0 to be closed

_ft_pad = np.zeros((num_timesteps, num_vertices_ft + 2, num_dim))
_cc_pad = np.zeros((num_timesteps, num_vertices_cc + 2, num_dim))

_ft_pad[:, :-2, :] = _ft
_cc_pad[:, :-2, :] = _cc

# +1 for the projection
# +1 for the origin

# TODO: compute the max curvature from the given data -> the gf_lm with the
# smaller value is assumed to be fully utilized: normaly the ft, which has
# max. strain -> compute the strain of cc and the curvature of it -> also
# eps_ca_max (max strain at the centroid axis)


def get_eps_ca_max():
    return None


gf_cc = m0(_cc[None, :, :])
gf_ft = m0(_ft[None, :, :])

ift = interpolate.interp1d(
    x=_ft[:, EPS], y=_ft[:, SIG], kind="linear", bounds_error=True, assume_sorted=True
)
icc = interpolate.interp1d(
    x=_cc[:, EPS], y=_cc[:, SIG], kind="linear", bounds_error=True, assume_sorted=True
)

k_eps0_M = np.array(
    [
        #        [0.0000000000, 0.0000000, 0],
        [0.0000001954, 0.0000063, 16_200],
        [0.0000003907, 0.0000126, 32_500],
        [0.0000005861, 0.0000189, 48_700],
        [0.0000007815, 0.0000253, 64_900],
        [0.0000009769, 0.0000316, 81_200],
        [0.0000011722, 0.0000379, 97_400],
        [0.0000013676, 0.0000442, 113_600],
        [0.0000015630, 0.0000505, 129_900],
        [0.0000017583, 0.0000568, 146_100],
        [0.0000019537, 0.0000631, 162_300],
        [0.0000021491, 0.0000694, 178_600],
        [0.0000023444, 0.0000758, 194_800],
        [0.0000025398, 0.0000821, 211_100],
        [0.0000027352, 0.0000884, 227_300],
        [0.0000029306, 0.0000947, 243_500],
        [0.0000031259, 0.0001010, 259_800],
        [0.0000033213, 0.0001073, 276_000],
        [0.0000035167, 0.0001136, 292_200],
        [0.0000037120, 0.0001200, 308_500],
        [0.0000039074, 0.0001263, 324_700],
        [0.0000041028, 0.0001326, 340_900],
        [0.0000042981, 0.0001389, 357_200],
        [0.0000044935, 0.0001452, 373_400],
        [0.0000046889, 0.0001515, 389_600],
        [0.0000048843, 0.0001578, 405_900],
        [0.0000050796, 0.0001642, 422_100],
        [0.0000052750, 0.0001705, 438_300],
        [0.0000054704, 0.0001768, 454_600],
        [0.0000056657, 0.0001831, 470_800],
        [0.0000058611, 0.0001894, 487_000],
        [0.0000060565, 0.0001957, 503_300],
        [0.0000062519, 0.0002020, 519_500],
        [0.0000064472, 0.0002083, 535_700],
        [0.0000066426, 0.0002147, 552_000],
        [0.0000068380, 0.0002210, 568_200],
        [0.0000070333, 0.0002273, 584_500],
        [0.0000072287, 0.0002336, 600_700],
        [0.0000074241, 0.0002399, 616_900],
        [0.0000076194, 0.0002462, 633_200],
        [0.0000078148, 0.0002525, 649_400],
        [0.0000080102, 0.0002589, 665_600],
        [0.0000082056, 0.0002652, 681_900],
        [0.0000084009, 0.0002715, 698_100],
        [0.0000085963, 0.0002778, 714_300],
        [0.0000087917, 0.0002841, 730_600],
        [0.0000089870, 0.0002904, 746_800],
        [0.0000091824, 0.0002967, 763_000],
        [0.0000093778, 0.0003030, 779_300],
        [0.0000095731, 0.0003094, 795_500],
        [0.0000097685, 0.0003157, 811_700],
        [0.0000099639, 0.0003220, 828_000],
        [0.0000101593, 0.0003283, 844_200],
        [0.0000103546, 0.0003346, 860_400],
        [0.0000105500, 0.0003409, 876_700],
        [0.0000107454, 0.0003472, 892_900],
        [0.0000109407, 0.0003536, 909_100],
        [0.0000111361, 0.0003600, 925_200],
        [0.0000113315, 0.0003666, 940_700],
        [0.0000115269, 0.0003735, 955_800],
        [0.0000117222, 0.0003806, 970_400],
        [0.0000119176, 0.0003879, 984_600],
        [0.0000121130, 0.0003954, 998_300],
        [0.0000123083, 0.0004032, 1_011_700],
        [0.0000125037, 0.0004111, 1_024_700],
        [0.0000126991, 0.0004193, 1_037_300],
        [0.0000128944, 0.0004276, 1_049_500],
        [0.0000130898, 0.0004362, 1_061_500],
        [0.0000132852, 0.0004449, 1_073_100],
        [0.0000134806, 0.0004537, 1_084_400],
        [0.0000136759, 0.0004628, 1_095_400],
        [0.0000138713, 0.0004720, 1_106_100],
        [0.0000140667, 0.0004814, 1_116_600],
        [0.0000142620, 0.0004909, 1_126_800],
        [0.0000144574, 0.0005006, 1_136_700],
        [0.0000146528, 0.0005105, 1_146_500],
        [0.0000148481, 0.0005205, 1_155_900],
        [0.0000150435, 0.0005307, 1_165_200],
        [0.0000152389, 0.0005409, 1_174_200],
        [0.0000154343, 0.0005514, 1_183_100],
        [0.0000156296, 0.0005619, 1_191_700],
        [0.0000158250, 0.0005726, 1_200_100],
        [0.0000160204, 0.0005835, 1_208_400],
        [0.0000162157, 0.0005944, 1_216_500],
        [0.0000164111, 0.0006055, 1_224_400],
        [0.0000166065, 0.0006167, 1_232_100],
        [0.0000168019, 0.0006280, 1_239_700],
        [0.0000169972, 0.0006395, 1_247_100],
        [0.0000171926, 0.0006510, 1_254_400],
        [0.0000173880, 0.0006627, 1_261_500],
        [0.0000175833, 0.0006745, 1_268_500],
        [0.0000177787, 0.0006864, 1_275_300],
        [0.0000179741, 0.0006984, 1_282_000],
        [0.0000181694, 0.0007105, 1_288_600],
        [0.0000183648, 0.0007227, 1_295_100],
        [0.0000185602, 0.0007350, 1_301_400],
        [0.0000187556, 0.0007474, 1_307_600],
        [0.0000189509, 0.0007599, 1_313_700],
        [0.0000191463, 0.0007725, 1_319_700],
        [0.0000193417, 0.0007852, 1_325_600],
        [0.0000195370, 0.0007980, 1_331_400],
        [0.0000197324, 0.0008109, 1_337_100],
        [0.0000199278, 0.0008239, 1_342_600],
        [0.0000201231, 0.0008370, 1_348_100],
        [0.0000203185, 0.0008501, 1_353_500],
        [0.0000205139, 0.0008633, 1_358_800],
        [0.0000207093, 0.0008767, 1_364_000],
        [0.0000209046, 0.0008900, 1_369_200],
        [0.0000211000, 0.0009035, 1_374_300],
        [0.0000212954, 0.0009169, 1_379_500],
        [0.0000214907, 0.0009303, 1_384_800],
        [0.0000216861, 0.0009438, 1_390_000],
        [0.0000218815, 0.0009573, 1_395_300],
        [0.0000220769, 0.0009708, 1_400_700],
        [0.0000222722, 0.0009844, 1_406_000],
        [0.0000224676, 0.0009979, 1_411_400],
        [0.0000226630, 0.0010115, 1_416_800],
        [0.0000228583, 0.0010250, 1_422_200],
        [0.0000230537, 0.0010386, 1_427_600],
        [0.0000232491, 0.0010523, 1_433_100],
        [0.0000234444, 0.0010659, 1_438_600],
        [0.0000236398, 0.0010795, 1_444_100],
        [0.0000238352, 0.0010932, 1_449_600],
        [0.0000240306, 0.0011069, 1_455_200],
        [0.0000242259, 0.0011206, 1_460_800],
        [0.0000244213, 0.0011343, 1_466_400],
        [0.0000246167, 0.0011480, 1_472_000],
        [0.0000248120, 0.0011617, 1_477_600],
        [0.0000250074, 0.0011755, 1_483_200],
        [0.0000252028, 0.0011893, 1_488_900],
        [0.0000253981, 0.0012030, 1_494_600],
        [0.0000255935, 0.0012168, 1_500_200],
        [0.0000257889, 0.0012306, 1_505_900],
        [0.0000259843, 0.0012445, 1_511_700],
        [0.0000261796, 0.0012583, 1_517_400],
        [0.0000263750, 0.0012721, 1_523_100],
        [0.0000265704, 0.0012860, 1_528_900],
        [0.0000267657, 0.0012999, 1_534_600],
        [0.0000269611, 0.0013137, 1_540_400],
        [0.0000271565, 0.0013276, 1_546_200],
        [0.0000273519, 0.0013415, 1_552_000],
        [0.0000275472, 0.0013554, 1_557_800],
        [0.0000277426, 0.0013694, 1_563_600],
        [0.0000279380, 0.0013833, 1_569_500],
        [0.0000281333, 0.0013973, 1_575_300],
        [0.0000283287, 0.0014112, 1_581_200],
        [0.0000285241, 0.0014252, 1_587_000],
        [0.0000287194, 0.0014392, 1_592_900],
        [0.0000289148, 0.0014532, 1_598_800],
        [0.0000291102, 0.0014672, 1_604_700],
        [0.0000293056, 0.0014812, 1_610_600],
        [0.0000295009, 0.0014952, 1_616_500],
        [0.0000296963, 0.0015092, 1_622_400],
        [0.0000298917, 0.0015232, 1_628_300],
        [0.0000300870, 0.0015373, 1_634_200],
        [0.0000302824, 0.0015513, 1_640_200],
        [0.0000304778, 0.0015654, 1_646_100],
        [0.0000306731, 0.0015794, 1_652_000],
        [0.0000308685, 0.0015934, 1_657_900],
        [0.0000310639, 0.0016073, 1_663_800],
        [0.0000312593, 0.0016212, 1_669_600],
        [0.0000314546, 0.0016350, 1_675_400],
        [0.0000316500, 0.0016488, 1_681_200],
        [0.0000318454, 0.0016626, 1_687_000],
        [0.0000320407, 0.0016763, 1_692_700],
        [0.0000322361, 0.0016899, 1_698_400],
        [0.0000324315, 0.0017035, 1_704_100],
        [0.0000326269, 0.0017170, 1_709_700],
        [0.0000328222, 0.0017305, 1_715_400],
        [0.0000330176, 0.0017440, 1_721_000],
        [0.0000332130, 0.0017574, 1_726_500],
        [0.0000334083, 0.0017708, 1_732_100],
        [0.0000336037, 0.0017841, 1_737_600],
        [0.0000337991, 0.0017974, 1_743_200],
        [0.0000339944, 0.0018106, 1_748_600],
        [0.0000341898, 0.0018238, 1_754_100],
        [0.0000343852, 0.0018369, 1_759_600],
        [0.0000345806, 0.0018500, 1_765_000],
        [0.0000347759, 0.0018630, 1_770_400],
        [0.0000349713, 0.0018760, 1_775_800],
        [0.0000351667, 0.0018890, 1_781_100],
        [0.0000353620, 0.0019019, 1_786_500],
        [0.0000355574, 0.0019148, 1_791_800],
        [0.0000357528, 0.0019276, 1_797_100],
        [0.0000359481, 0.0019404, 1_802_400],
        [0.0000361435, 0.0019531, 1_807_600],
        [0.0000363389, 0.0019658, 1_812_900],
        [0.0000365343, 0.0019784, 1_818_100],
        [0.0000367296, 0.0019910, 1_823_300],
        [0.0000369250, 0.0020036, 1_828_500],
        [0.0000371204, 0.0020161, 1_833_600],
        [0.0000373157, 0.0020286, 1_838_800],
        [0.0000375111, 0.0020410, 1_843_900],
        [0.0000377065, 0.0020534, 1_849_000],
        [0.0000379019, 0.0020657, 1_854_100],
        [0.0000380972, 0.0020780, 1_859_200],
        [0.0000382926, 0.0020903, 1_864_300],
        [0.0000384880, 0.0021025, 1_869_300],
        [0.0000386833, 0.0021147, 1_874_300],
        [0.0000388787, 0.0021268, 1_879_300],
        [0.0000390741, 0.0021389, 1_884_300],
    ]
)

K = k_eps0_M[:, 0]
EPS_0 = k_eps0_M[:, 1]
Mtar = k_eps0_M[:, 2]

eps_ca_max = k_eps0_M[-1, 1]
bounds = Bounds(lb=0, ub=eps_ca_max, keep_feasible=True)


if __name__ == "__main__":

    eps_cc = np.linspace(0, 10 / 1000, num_timesteps)  # .reshape(-1, 1)

    _cc_pad = prep(eps_cc, _cc, icc, _cc_pad)

    # vec_sig = icc(vec_eps)  # working
    #
    # vec_id = np.searchsorted(_cc[:, EPS], vec_eps, side="left")  #
    # # working
    #
    # _cc_pad[all_timesteps, vec_id, EPS] = vec_eps
    # _cc_pad[all_timesteps, vec_id, SIG] = vec_sig
    #
    # _cc_pad[all_timesteps, vec_id + 1, EPS] = vec_eps
    # _cc_pad[all_timesteps, vec_id + 1, SIG] = 0
    #
    # mask = np.arange(_cc.shape[0] + 2) > (vec_id[:, None] + 1)
    # _cc_pad[mask] = 0

    m0cc = m0(_cc_pad)
    m1cc = m1(_cc_pad)


    pass
